<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple SFX Generator</title>
    <script src="https://unpkg.com/tone@15.1.22/build/Tone.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f7;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        button:hover {
            background: #0051D0;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        .mixed-button {
            background: #34C759 !important;
        }
        .mixed-button:hover {
            background: #28A745 !important;
        }
        .instrument-selector, .custom-sound, .mixed-instruments {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        input, select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin: 5px;
        }
        .timeline-controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .timeline-controls button {
            padding: 8px 15px;
            font-size: 14px;
        }
        .element-palette {
            margin: 15px 0;
            padding: 15px;
            background: #f0f0f2;
            border-radius: 8px;
            border: 2px dashed #ccc;
        }
        .palette-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #666;
        }
        .element-item {
            display: inline-block;
            padding: 8px 12px;
            margin: 5px;
            background: #007AFF;
            color: white;
            border-radius: 6px;
            cursor: grab;
            user-select: none;
            font-size: 12px;
        }
        .element-item:active {
            cursor: grabbing;
        }
        .timeline-container {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin: 15px 0;
        }
        .timeline-header {
            width: 100px;
            background: #f8f8f8;
            border-right: 1px solid #ddd;
        }
        .track-label {
            height: 50px;
            padding: 15px 10px;
            border-bottom: 1px solid #ddd;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            background: #f0f0f0;
        }
        .track-label:last-child {
            border-bottom: none;
        }
        .timeline-grid {
            flex: 1;
            background: linear-gradient(90deg, transparent 24px, #e0e0e0 25px);
            background-size: 100px 1px;
            position: relative;
        }
        .timeline-track {
            height: 50px;
            border-bottom: 1px solid #ddd;
            position: relative;
            background: repeating-linear-gradient(90deg, transparent, transparent 99px, #e0e0e0 100px);
        }
        .timeline-track:last-child {
            border-bottom: none;
        }
        .timeline-track.drag-over {
            background-color: rgba(0, 122, 255, 0.1);
        }
        .timeline-element {
            position: absolute;
            height: 30px;
            top: 10px;
            background: #34C759;
            color: white;
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 11px;
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            min-width: 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .timeline-element:hover {
            background: #28A745;
        }
        .sound-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }
        .sound-row button {
            flex: 1;
        }
        .export-btn {
            background: #FF9500 !important;
            min-width: 80px;
            flex: 0 0 auto;
        }
        .export-btn:hover {
            background: #CC7700 !important;
        }
    </style>
</head>
<body>
    <h1>🔊 Apple SFX Generator</h1>
    <p>Click buttons to generate Apple-style UI sound effects</p>

    <div class="instrument-selector">
        <h3>🎹 Instrument</h3>
        <select id="instrumentSelect">
            <option value="sine">Sine Wave (Pure, Clean)</option>
            <option value="triangle">Triangle Wave (Warm, Soft)</option>
            <option value="sawtooth">Sawtooth (Bright, Electronic)</option>
            <option value="square">Square Wave (Digital, Retro)</option>
            <option value="fmsine">FM Synthesis (Bell-like)</option>
            <option value="pluck">Pluck (String Attack)</option>
            <option value="piano">🎹 Piano (Realistic Keys)</option>
            <option value="marimba">🔨 Marimba (Wooden Mallets)</option>
            <option value="metalphone">🔔 Metalphone (Bell Chimes)</option>
            <option value="harp">🪈 Harp (String Plucks)</option>
        </select>
    </div>

    <div class="instrument-selector">
        <h3>🎛️ Analog Effects</h3>
        <select id="effectsSelect">
            <option value="none">Clean (No Effects)</option>
            <option value="vintage">Vintage Warmth (Chorus + Saturation)</option>
            <option value="analog">Analog Hardware (Compressor + Chorus)</option>
            <option value="lofi">Lo-Fi Character (BitCrush + Filter)</option>
            <option value="tube">Tube Amp (Distortion + Warmth)</option>
            <option value="spacey">Spacey (Phaser + Delay)</option>
            <option value="underwater">Underwater (Filter Sweep + Chorus)</option>
        </select>
    </div>

    <div class="controls">
        <div class="sound-row">
            <button onclick="sfx.notificationChime()">Notification Chime</button>
            <button class="export-btn" onclick="exportSound('notificationChime', 'notification-chime')">📥 Export</button>
        </div>
        <div class="sound-row">
            <button onclick="sfx.successSound()">Success Sound</button>
            <button class="export-btn" onclick="exportSound('successSound', 'success-sound')">📥 Export</button>
        </div>
        <div class="sound-row">
            <button onclick="sfx.buttonClick()">Button Click</button>
            <button class="export-btn" onclick="exportSound('buttonClick', 'button-click')">📥 Export</button>
        </div>
        <div class="sound-row">
            <button onclick="sfx.errorSound()">Error Sound</button>
            <button class="export-btn" onclick="exportSound('errorSound', 'error-sound')">📥 Export</button>
        </div>
        <div class="sound-row">
            <button onclick="sfx.swipeSound()">Swipe Sound</button>
            <button class="export-btn" onclick="exportSound('swipeSound', 'swipe-sound')">📥 Export</button>
        </div>
        <div class="sound-row">
            <button onclick="sfx.modalAppear()">Modal Appear</button>
            <button class="export-btn" onclick="exportSound('modalAppear', 'modal-appear')">📥 Export</button>
        </div>
    </div>

    <div class="mixed-instruments">
        <h3>💰 Mixed Instrument Effects</h3>
        <p>Layered sounds combining multiple synthesizers</p>
        <div class="controls">
            <div class="sound-row">
                <button class="mixed-button" onclick="sfx.cashOutSound()">💰 Cash Out</button>
                <button class="export-btn" onclick="exportSound('cashOutSound', 'cash-out')">📥 Export</button>
            </div>
            <div class="sound-row">
                <button class="mixed-button" onclick="sfx.levelUpSound()">⬆️ Level Up</button>
                <button class="export-btn" onclick="exportSound('levelUpSound', 'level-up')">📥 Export</button>
            </div>
            <div class="sound-row">
                <button class="mixed-button" onclick="sfx.magicSparkSound()">✨ Magic Spark</button>
                <button class="export-btn" onclick="exportSound('magicSparkSound', 'magic-spark')">📥 Export</button>
            </div>
            <div class="sound-row">
                <button class="mixed-button" onclick="sfx.coinDropSound()">🪙 Coin Drop</button>
                <button class="export-btn" onclick="exportSound('coinDropSound', 'coin-drop')">📥 Export</button>
            </div>
            <div class="sound-row">
                <button class="mixed-button" onclick="sfx.windChimeSound()">🎐 Wind Chime</button>
                <button class="export-btn" onclick="exportSound('windChimeSound', 'wind-chime')">📥 Export</button>
            </div>
            <div class="sound-row">
                <button class="mixed-button" onclick="sfx.treasureOpenSound()">🏴‍☠️ Treasure Open</button>
                <button class="export-btn" onclick="exportSound('treasureOpenSound', 'treasure-open')">📥 Export</button>
            </div>
            <div class="sound-row">
                <button class="mixed-button" onclick="sfx.crystalResonanceSound()">💎 Crystal Resonance</button>
                <button class="export-btn" onclick="exportSound('crystalResonanceSound', 'crystal-resonance')">📥 Export</button>
            </div>
            <div class="sound-row">
                <button class="mixed-button" onclick="sfx.gentleRainSound()">🌧️ Gentle Rain</button>
                <button class="export-btn" onclick="exportSound('gentleRainSound', 'gentle-rain')">📥 Export</button>
            </div>
        </div>
    </div>

    <div class="custom-sound">
        <h3>🎛️ SFX Timeline Builder</h3>
        <p>Drag elements onto tracks to create layered sound effects</p>
        
        <div class="timeline-controls">
            <button id="playTimeline">▶️ Play</button>
            <button id="stopTimeline">⏹️ Stop</button>
            <button id="clearTimeline">🗑️ Clear</button>
            <span>Duration: 2.0s</span>
        </div>

        <div class="element-palette">
            <div class="palette-title">Drag to Timeline:</div>
            <div class="element-item" draggable="true" data-instrument="pluck" data-note="G5">🎸 Pluck G5</div>
            <div class="element-item" draggable="true" data-instrument="metalphone" data-note="G5">🔔 Metal G5</div>
            <div class="element-item" draggable="true" data-instrument="marimba" data-note="G4">🔨 Marimba G4</div>
            <div class="element-item" draggable="true" data-instrument="harp" data-note="C5">🪈 Harp C5</div>
        </div>

        <div class="timeline-container">
            <div class="timeline-header">
                <div class="track-label">Pluck</div>
                <div class="track-label">Metalphone</div>
                <div class="track-label">Marimba</div>
                <div class="track-label">Harp</div>
            </div>
            <div class="timeline-grid">
                <div class="timeline-track" data-track="pluck"></div>
                <div class="timeline-track" data-track="metalphone"></div>
                <div class="timeline-track" data-track="marimba"></div>
                <div class="timeline-track" data-track="harp"></div>
            </div>
        </div>
    </div>

    <div class="custom-sound">
        <h3>Custom Sound Generator</h3>
        <select id="noteSelect">
            <option value="C4">C4</option>
            <option value="D4">D4</option>
            <option value="E4">E4</option>
            <option value="F4">F4</option>
            <option value="G4">G4</option>
            <option value="A4">A4</option>
            <option value="B4">B4</option>
            <option value="C5">C5</option>
            <option value="D5">D5</option>
            <option value="E5">E5</option>
            <option value="F5">F5</option>
            <option value="G5">G5</option>
            <option value="A5">A5</option>
            <option value="B5">B5</option>
            <option value="C6">C6</option>
        </select>
        <input type="range" id="durationSlider" min="0.05" max="1" step="0.05" value="0.1">
        <span id="durationValue">0.1s</span>
        <button onclick="playCustomSound()">Play Custom</button>
    </div>

    <script>
        class AppleSFXGenerator {
            constructor() {
                this.reverb = null;
                this.effectsChain = null;
                this.synth = null;
                this.pluckSynth = null;
                this.metalphoneSynth = null;
                this.marimbaSync = null;
                this.harpSynth = null;
                this.initialized = false;
                this.currentInstrument = 'sine';
                this.currentEffect = 'none';
                this.timelineElements = [];
                this.isPlaying = false;
                this.recorder = null;
            }

            async init() {
                if (this.initialized) return;
                
                await Tone.start();
                
                this.reverb = new Tone.Reverb({
                    decay: 1.5,
                    wet: 0.3
                });
                
                this.createEffectsChain();
                this.createSynth();
                this.createMixedSynths();
                await this.reverb.generate();
                this.initialized = true;
            }

            createSynth() {
                if (this.synth) {
                    this.synth.dispose();
                }

                const instrument = this.currentInstrument;
                
                if (instrument === 'pluck') {
                    this.synth = new Tone.PluckSynth({
                        attackNoise: 1,
                        dampening: 4000,
                        resonance: 0.7
                    }).connect(this.effectsChain);
                } else if (instrument === 'fmsine') {
                    this.synth = new Tone.FMSynth({
                        harmonicity: 3,
                        modulationIndex: 10,
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.8 },
                        modulation: { type: 'sine' },
                        modulationEnvelope: { attack: 0.006, decay: 0.2, sustain: 0.1, release: 0.8 }
                    }).connect(this.effectsChain);
                } else if (instrument === 'piano') {
                    this.synth = new Tone.Synth({
                        oscillator: { type: 'triangle' },
                        envelope: { attack: 0.001, decay: 0.3, sustain: 0.1, release: 1.2 }
                    }).connect(this.effectsChain);
                } else if (instrument === 'marimba') {
                    this.synth = new Tone.FMSynth({
                        harmonicity: 2,
                        modulationIndex: 20,
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.001, decay: 0.2, sustain: 0.1, release: 1.0 },
                        modulation: { type: 'sine' },
                        modulationEnvelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.3 }
                    }).connect(this.effectsChain);
                } else if (instrument === 'metalphone') {
                    this.synth = new Tone.FMSynth({
                        harmonicity: 8,
                        modulationIndex: 12,
                        oscillator: { type: 'sine' },
                        envelope: { attack: 0.001, decay: 0.5, sustain: 0.2, release: 2.0 },
                        modulation: { type: 'sine' },
                        modulationEnvelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
                    }).connect(this.effectsChain);
                } else if (instrument === 'harp') {
                    this.synth = new Tone.PluckSynth({
                        attackNoise: 0.2,
                        dampening: 6000,
                        resonance: 0.9
                    }).connect(this.effectsChain);
                } else {
                    this.synth = new Tone.Synth({
                        oscillator: { type: instrument },
                        envelope: {
                            attack: 0.005,
                            decay: 0.1,
                            sustain: 0.3,
                            release: 0.8
                        }
                    }).connect(this.effectsChain);
                }
            }

            async changeInstrument(instrument) {
                this.currentInstrument = instrument;
                if (this.initialized) {
                    this.createSynth();
                }
            }

            createEffectsChain() {
                // Properly dispose existing effects but keep reverb
                if (this.effectsChain && this.effectsChain !== this.reverb) {
                    this.effectsChain.dispose();
                }
                
                // Disconnect reverb from destination
                this.reverb.disconnect();

                const effect = this.currentEffect;
                
                if (effect === 'vintage') {
                    // Chorus + Saturation for vintage warmth
                    const chorus = new Tone.Chorus(4, 2.5, 0.5);
                    const distortion = new Tone.Distortion(0.2);
                    this.effectsChain = chorus.chain(distortion, this.reverb).toDestination();
                } else if (effect === 'analog') {
                    // Compressor + Chorus for hardware feel
                    const compressor = new Tone.Compressor(-30, 3);
                    const chorus = new Tone.Chorus(2, 3.5, 0.3);
                    this.effectsChain = compressor.chain(chorus, this.reverb).toDestination();
                } else if (effect === 'lofi') {
                    // BitCrush + Filter for lo-fi character
                    const bitCrush = new Tone.BitCrusher(6);
                    const filter = new Tone.Filter(2000, "lowpass");
                    this.effectsChain = bitCrush.chain(filter, this.reverb).toDestination();
                } else if (effect === 'tube') {
                    // Distortion + Warmth for tube amp
                    const distortion = new Tone.Distortion(0.4);
                    const filter = new Tone.Filter(3000, "lowpass");
                    this.effectsChain = distortion.chain(filter, this.reverb).toDestination();
                } else if (effect === 'spacey') {
                    // Phaser + Delay for spacey effects
                    const phaser = new Tone.Phaser(0.5, 3, 350);
                    const delay = new Tone.Delay(0.2);
                    this.effectsChain = phaser.chain(delay, this.reverb).toDestination();
                } else if (effect === 'underwater') {
                    // Filter Sweep + Chorus for underwater feel
                    const autoFilter = new Tone.AutoFilter(0.3, 200, 4);
                    const chorus = new Tone.Chorus(6, 2, 0.8);
                    this.effectsChain = autoFilter.chain(chorus, this.reverb).toDestination();
                    autoFilter.start();
                } else {
                    // Clean - no effects, just reverb directly to destination
                    this.effectsChain = this.reverb.toDestination();
                }
            }

            async changeEffect(effect) {
                this.currentEffect = effect;
                if (this.initialized) {
                    this.createEffectsChain();
                    this.createSynth();
                    this.createMixedSynths();
                }
            }

            createMixedSynths() {
                // Dispose existing synths
                if (this.pluckSynth) this.pluckSynth.dispose();
                if (this.metalphoneSynth) this.metalphoneSynth.dispose();
                if (this.marimbaSync) this.marimbaSync.dispose();
                if (this.harpSynth) this.harpSynth.dispose();

                // Create dedicated synths for mixing
                this.pluckSynth = new Tone.PluckSynth({
                    attackNoise: 1,
                    dampening: 4000,
                    resonance: 0.7
                }).connect(this.effectsChain);

                this.metalphoneSynth = new Tone.FMSynth({
                    harmonicity: 8,
                    modulationIndex: 12,
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.5, sustain: 0.2, release: 2.0 },
                    modulation: { type: 'sine' },
                    modulationEnvelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
                }).connect(this.effectsChain);

                this.marimbaSync = new Tone.FMSynth({
                    harmonicity: 2,
                    modulationIndex: 20,
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0.1, release: 1.0 },
                    modulation: { type: 'sine' },
                    modulationEnvelope: { attack: 0.001, decay: 0.3, sustain: 0, release: 0.3 }
                }).connect(this.effectsChain);

                this.harpSynth = new Tone.PluckSynth({
                    attackNoise: 0.2,
                    dampening: 6000,
                    resonance: 0.9
                }).connect(this.effectsChain);
            }

            async ensureInit() {
                if (!this.initialized) await this.init();
            }

            async notificationChime() {
                await this.ensureInit();
                const now = Tone.now();
                this.synth.triggerAttackRelease('G5', '0.15', now);
                this.synth.triggerAttackRelease('C6', '0.2', now + 0.1);
            }

            async successSound() {
                await this.ensureInit();
                const now = Tone.now();
                this.synth.triggerAttackRelease('C5', '0.1', now);
                this.synth.triggerAttackRelease('E5', '0.1', now + 0.05);
                this.synth.triggerAttackRelease('G5', '0.15', now + 0.1);
            }

            async buttonClick() {
                await this.ensureInit();
                this.synth.triggerAttackRelease('C6', '0.05');
            }

            async errorSound() {
                await this.ensureInit();
                const now = Tone.now();
                this.synth.triggerAttackRelease('F4', '0.1', now);
                this.synth.triggerAttackRelease('D4', '0.15', now + 0.05);
            }

            async swipeSound() {
                await this.ensureInit();
                const now = Tone.now();
                this.synth.triggerAttackRelease('A4', '0.08', now);
                this.synth.triggerAttackRelease('C5', '0.06', now + 0.04);
            }

            async modalAppear() {
                await this.ensureInit();
                const now = Tone.now();
                this.synth.triggerAttackRelease('G4', '0.12', now);
                this.synth.triggerAttackRelease('D5', '0.18', now + 0.08);
            }

            async customSound(note, duration = '0.1') {
                await this.ensureInit();
                this.synth.triggerAttackRelease(note, duration);
            }

            // Mixed instrument sounds
            async cashOutSound() {
                await this.ensureInit();
                const now = Tone.now();
                
                // Initial pluck for that satisfying "cha-ching" attack
                this.pluckSynth.triggerAttackRelease('G5', '0.1', now);
                
                // Layered metalphone with waning effect (slides down but stays positive)
                this.metalphoneSynth.triggerAttackRelease('G5', '0.8', now + 0.05);
                this.metalphoneSynth.triggerAttackRelease('D5', '0.6', now + 0.15);
                this.metalphoneSynth.triggerAttackRelease('A4', '0.4', now + 0.3);
                
                // Additional harmonic for richness
                this.metalphoneSynth.triggerAttackRelease('B4', '0.5', now + 0.2);
            }

            async levelUpSound() {
                await this.ensureInit();
                const now = Tone.now();
                
                // Ascending pluck sequence
                this.pluckSynth.triggerAttackRelease('C5', '0.08', now);
                this.pluckSynth.triggerAttackRelease('E5', '0.08', now + 0.06);
                this.pluckSynth.triggerAttackRelease('G5', '0.08', now + 0.12);
                
                // Sustained metalphone harmony
                this.metalphoneSynth.triggerAttackRelease('C6', '0.6', now + 0.15);
                this.metalphoneSynth.triggerAttackRelease('E6', '0.4', now + 0.2);
            }

            async magicSparkSound() {
                await this.ensureInit();
                const now = Tone.now();
                
                // Quick pluck arpeggios
                this.pluckSynth.triggerAttackRelease('C6', '0.05', now);
                this.pluckSynth.triggerAttackRelease('E6', '0.05', now + 0.03);
                this.pluckSynth.triggerAttackRelease('G6', '0.05', now + 0.06);
                
                // Shimmering metalphone notes
                this.metalphoneSynth.triggerAttackRelease('C7', '0.3', now + 0.05);
                this.metalphoneSynth.triggerAttackRelease('G6', '0.4', now + 0.1);
            }

            async coinDropSound() {
                await this.ensureInit();
                const now = Tone.now();
                
                // High pluck for the "clink"
                this.pluckSynth.triggerAttackRelease('C6', '0.06', now);
                
                // Descending metalphone notes for the "drop" bounce effect
                this.metalphoneSynth.triggerAttackRelease('A5', '0.15', now + 0.05);
                this.metalphoneSynth.triggerAttackRelease('F5', '0.12', now + 0.12);
                this.metalphoneSynth.triggerAttackRelease('D5', '0.1', now + 0.18);
            }

            async windChimeSound() {
                await this.ensureInit();
                const now = Tone.now();
                
                // Metalphone for bell tones + Harp for gentle plucks
                this.metalphoneSynth.triggerAttackRelease('C6', '1.2', now);
                this.metalphoneSynth.triggerAttackRelease('E6', '1.0', now + 0.1);
                this.metalphoneSynth.triggerAttackRelease('G6', '0.8', now + 0.2);
                
                this.harpSynth.triggerAttackRelease('C5', '0.3', now + 0.05);
                this.harpSynth.triggerAttackRelease('F5', '0.3', now + 0.15);
                this.harpSynth.triggerAttackRelease('A5', '0.3', now + 0.25);
            }

            async treasureOpenSound() {
                await this.ensureInit();
                const now = Tone.now();
                
                // Marimba for wooden chest creak + Metalphone for treasure sparkle
                this.marimbaSync.triggerAttackRelease('F3', '0.2', now);
                this.marimbaSync.triggerAttackRelease('C4', '0.15', now + 0.1);
                
                // Treasure sparkle cascade
                this.metalphoneSynth.triggerAttackRelease('C6', '0.4', now + 0.2);
                this.metalphoneSynth.triggerAttackRelease('E6', '0.4', now + 0.25);
                this.metalphoneSynth.triggerAttackRelease('G6', '0.4', now + 0.3);
                this.metalphoneSynth.triggerAttackRelease('C7', '0.6', now + 0.35);
            }

            async crystalResonanceSound() {
                await this.ensureInit();
                const now = Tone.now();
                
                // Pure metalphone resonance with harmonic overtones
                this.metalphoneSynth.triggerAttackRelease('C5', '1.5', now);
                this.metalphoneSynth.triggerAttackRelease('G5', '1.2', now + 0.1);
                this.metalphoneSynth.triggerAttackRelease('E6', '1.0', now + 0.2);
                this.metalphoneSynth.triggerAttackRelease('C6', '0.8', now + 0.3);
                
                // Harp overtones for ethereal quality
                this.harpSynth.triggerAttackRelease('C4', '0.6', now + 0.15);
                this.harpSynth.triggerAttackRelease('G4', '0.6', now + 0.25);
            }

            async gentleRainSound() {
                await this.ensureInit();
                const now = Tone.now();
                
                // Multiple quick plucks for raindrops + Marimba for distant thunder
                this.pluckSynth.triggerAttackRelease('A5', '0.03', now);
                this.pluckSynth.triggerAttackRelease('F5', '0.03', now + 0.02);
                this.pluckSynth.triggerAttackRelease('D5', '0.03', now + 0.04);
                this.pluckSynth.triggerAttackRelease('G5', '0.03', now + 0.06);
                this.pluckSynth.triggerAttackRelease('C5', '0.03', now + 0.08);
                
                // Gentle marimba roll
                this.marimbaSync.triggerAttackRelease('F3', '0.4', now + 0.1);
                this.marimbaSync.triggerAttackRelease('A3', '0.3', now + 0.2);
            }

            // Timeline methods
            addTimelineElement(instrument, note, time) {
                const element = {
                    id: Date.now() + Math.random(),
                    instrument,
                    note,
                    time,
                    duration: 0.2
                };
                this.timelineElements.push(element);
                return element;
            }

            removeTimelineElement(id) {
                this.timelineElements = this.timelineElements.filter(el => el.id !== id);
            }

            clearTimeline() {
                this.timelineElements = [];
                this.stopTimeline();
            }

            async playTimeline() {
                if (this.isPlaying) return;
                await this.ensureInit();
                
                this.isPlaying = true;
                Tone.Transport.cancel();
                
                // Schedule all elements
                this.timelineElements.forEach(element => {
                    Tone.Transport.schedule((time) => {
                        const synth = this.getSynthForInstrument(element.instrument);
                        if (synth) {
                            synth.triggerAttackRelease(element.note, element.duration, time);
                        }
                    }, element.time);
                });

                // Stop after 2 seconds
                Tone.Transport.schedule(() => {
                    this.stopTimeline();
                }, 2);

                Tone.Transport.start();
            }

            stopTimeline() {
                this.isPlaying = false;
                Tone.Transport.stop();
                Tone.Transport.cancel();
            }

            getSynthForInstrument(instrument) {
                switch(instrument) {
                    case 'pluck': return this.pluckSynth;
                    case 'metalphone': return this.metalphoneSynth;
                    case 'marimba': return this.marimbaSync;
                    case 'harp': return this.harpSynth;
                    default: return null;
                }
            }

            // Recording methods
            async startRecording() {
                await this.ensureInit();
                if (this.recorder) {
                    this.recorder.dispose();
                }
                this.recorder = new Tone.Recorder();
                Tone.Destination.connect(this.recorder);
                this.recorder.start();
            }

            async stopRecording() {
                if (!this.recorder) return null;
                const recording = await this.recorder.stop();
                return recording;
            }

            async recordAndExport(soundFunction, filename = 'sfx') {
                await this.startRecording();
                
                // Play the sound
                await soundFunction.call(this);
                
                // Wait a bit longer than the sound to capture full decay
                setTimeout(async () => {
                    const recording = await this.stopRecording();
                    if (recording) {
                        this.downloadRecording(recording, filename);
                    }
                }, 3000);
            }

            downloadRecording(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.webm`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        const sfx = new AppleSFXGenerator();

        // Instrument selector
        const instrumentSelect = document.getElementById('instrumentSelect');
        instrumentSelect.addEventListener('change', async () => {
            await sfx.changeInstrument(instrumentSelect.value);
        });

        // Effects selector
        const effectsSelect = document.getElementById('effectsSelect');
        effectsSelect.addEventListener('change', async () => {
            await sfx.changeEffect(effectsSelect.value);
        });

        // Custom sound controls
        const durationSlider = document.getElementById('durationSlider');
        const durationValue = document.getElementById('durationValue');
        
        durationSlider.addEventListener('input', () => {
            durationValue.textContent = durationSlider.value + 's';
        });

        async function playCustomSound() {
            const note = document.getElementById('noteSelect').value;
            const duration = durationSlider.value;
            await sfx.customSound(note, duration);
        }

        // Timeline functionality
        let draggedElement = null;

        function initTimeline() {
            // Timeline controls
            document.getElementById('playTimeline').addEventListener('click', () => {
                sfx.playTimeline();
            });
            
            document.getElementById('stopTimeline').addEventListener('click', () => {
                sfx.stopTimeline();
            });
            
            document.getElementById('clearTimeline').addEventListener('click', () => {
                sfx.clearTimeline();
                updateTimelineDisplay();
            });

            // Drag and drop setup
            const elementItems = document.querySelectorAll('.element-item');
            const timelineTracks = document.querySelectorAll('.timeline-track');

            elementItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedElement = {
                        instrument: e.target.dataset.instrument,
                        note: e.target.dataset.note,
                        text: e.target.textContent
                    };
                });
            });

            timelineTracks.forEach(track => {
                track.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    track.classList.add('drag-over');
                });

                track.addEventListener('dragleave', () => {
                    track.classList.remove('drag-over');
                });

                track.addEventListener('drop', (e) => {
                    e.preventDefault();
                    track.classList.remove('drag-over');
                    
                    if (draggedElement && draggedElement.instrument === track.dataset.track) {
                        const rect = track.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const time = (x / rect.width) * 2; // 2 second timeline
                        
                        if (time >= 0 && time <= 2) {
                            const element = sfx.addTimelineElement(
                                draggedElement.instrument,
                                draggedElement.note,
                                time
                            );
                            updateTimelineDisplay();
                        }
                    }
                    draggedElement = null;
                });
            });
        }

        function updateTimelineDisplay() {
            const tracks = document.querySelectorAll('.timeline-track');
            
            // Clear existing elements
            tracks.forEach(track => {
                const elements = track.querySelectorAll('.timeline-element');
                elements.forEach(el => el.remove());
            });

            // Add current elements
            sfx.timelineElements.forEach(element => {
                const track = document.querySelector(`[data-track="${element.instrument}"]`);
                if (track) {
                    const timelineEl = document.createElement('div');
                    timelineEl.className = 'timeline-element';
                    timelineEl.textContent = element.note;
                    timelineEl.style.left = (element.time / 2) * 100 + '%';
                    
                    // Click to remove
                    timelineEl.addEventListener('click', () => {
                        sfx.removeTimelineElement(element.id);
                        updateTimelineDisplay();
                    });
                    
                    track.appendChild(timelineEl);
                }
            });
        }

        // Export functionality
        async function exportSound(functionName, filename) {
            // Get the current settings
            const currentInstrument = sfx.currentInstrument;
            const currentEffect = sfx.currentEffect;
            
            // If user wants pluck with no effects for success sound
            if (functionName === 'successSound') {
                await sfx.changeInstrument('pluck');
                await sfx.changeEffect('none');
            }
            
            // Record and export the sound
            await sfx.recordAndExport(sfx[functionName], filename);
            
            // Restore original settings
            await sfx.changeInstrument(currentInstrument);
            await sfx.changeEffect(currentEffect);
        }

        // Initialize timeline when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initTimeline();
        });
    </script>
</body>
</html>